<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de FAQ Jer√°rquico - WidKit</title>
    <meta name="description" content="Sistema de gesti√≥n de preguntas frecuentes con estructura jer√°rquica de nodos">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .node-children {
            margin-left: 2rem;
            border-left: 2px solid #e2e8f0;
        }
        .collapse-arrow {
            transition: transform 0.2s;
        }
        .collapse-arrow.open {
            transform: rotate(90deg);
        }
        .search-highlight {
            background-color: yellow;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center p-2">
                            <img src="../../assets/widkit_fuego_icono.png" alt="WidKit" class="w-full h-full object-contain">
                        </div>
                        <h1 class="text-xl font-bold text-slate-900">FAQ Admin</h1>
                    </div>
                    <div class="flex gap-2">
                        <a href="../../app/faq.html" target="_blank" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition">
                            üëÅÔ∏è Ver P√∫blico
                        </a>
                        <a href="../../index.html" class="px-4 py-2 text-slate-700 hover:bg-slate-100 rounded-lg transition">‚Üê Volver</a>
                    </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Panel de Gesti√≥n (Izquierda) -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-8">
                    <h2 class="text-2xl font-bold text-slate-900 mb-4">‚öôÔ∏è Gesti√≥n</h2>
                    
                    <!-- B√∫squeda -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">üîç Buscar</label>
                        <input type="text" id="searchInput" 
                               class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                               placeholder="Buscar por t√≠tulo o descripci√≥n...">
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="space-y-3">
                        <button onclick="showCreateModal()" 
                                class="w-full px-4 py-3 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition">
                            ‚ûï Crear Nodo Ra√≠z
                        </button>
                        <button onclick="exportJSON()" 
                                class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                            üì• Exportar JSON
                        </button>
                        <button onclick="importJSON()" 
                                class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                            üì§ Importar JSON
                        </button>
                        <button onclick="resetToDefaults()" 
                                class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                            üîÑ Resetear a Predeterminado
                        </button>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div class="mt-6 p-4 bg-slate-100 rounded-lg">
                        <h3 class="font-bold text-slate-900 mb-2">üìä Estad√≠sticas</h3>
                        <div class="space-y-1 text-sm text-slate-600">
                            <div>Total nodos: <span class="font-bold" id="totalNodes">0</span></div>
                            <div>Nodos ra√≠z: <span class="font-bold" id="rootNodes">0</span></div>
                            <div>Profundidad m√°xima: <span class="font-bold" id="maxDepth">0</span></div>
                        </div>
                    </div>

                    <!-- Compartir / Embed -->
                    <div class="mt-6 p-4 bg-slate-100 rounded-lg">
                        <h3 class="font-bold text-slate-900 mb-2">üîó Compartir</h3>
                        <div class="flex gap-2 mb-3">
                            <button onclick="generateShare()" class="px-3 py-2 bg-violet-600 hover:bg-violet-700 text-white text-sm font-semibold rounded-lg transition">Generar Enlace</button>
                            <button onclick="copyEmbed()" class="px-3 py-2 bg-slate-800 hover:bg-black text-white text-sm font-semibold rounded-lg transition">Copiar Iframe</button>
                        </div>
                        <textarea id="shareOutput" class="w-full text-xs p-2 border border-slate-300 rounded-lg" rows="3" readonly></textarea>
                    </div>
                </div>
            </div>

            <!-- Vista del √Årbol (Derecha) -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-900">üìö √Årbol de FAQ</h2>
                        <button onclick="collapseAll()" 
                                class="px-3 py-1 text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition">
                            üîΩ Colapsar Todo
                        </button>
                    </div>
                    <div id="treeContainer" class="space-y-2">
                        <!-- Los nodos se renderizan aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Crear/Editar Nodo -->
    <div id="nodeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <h3 class="text-2xl font-bold text-slate-900 mb-4" id="modalTitle">Crear Nodo</h3>
            
            <input type="hidden" id="nodeId">
            <input type="hidden" id="parentId">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">T√≠tulo *</label>
                    <input type="text" id="nodeTitle" 
                           class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                           placeholder="Ej: Becas">
                    <div id="titleError" class="text-red-600 text-xs mt-1 hidden"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Descripci√≥n</label>
                    <textarea id="nodeDesc" rows="4"
                              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                              placeholder="Contenido de la respuesta..."></textarea>
                </div>

                <div id="parentInfo" class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
                    <strong>Padre:</strong> <span id="parentTitle">Ra√≠z</span>
                </div>

                <div class="flex gap-3">
                    <button onclick="saveNode()" 
                            class="flex-1 px-4 py-3 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition">
                        üíæ Guardar
                    </button>
                    <button onclick="closeModal()" 
                            class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg transition">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <h3 class="text-2xl font-bold text-slate-900 mb-4">‚ö†Ô∏è Confirmar</h3>
            <p class="text-slate-600 mb-6" id="confirmMessage"></p>
            <div class="flex gap-3">
                <button onclick="confirmAction()" 
                        class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                    Confirmar
                </button>
                <button onclick="cancelConfirm()" 
                        class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg transition">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Input oculto para importar JSON -->
    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <script>
        // ============================================
        // MODELO DE DATOS Y STORAGE
        // ============================================

        class Nodo {
            constructor(id, titulo, descripcion, id_nodo_padre = null, orden = 0) {
                this.id_nodo = id;
                this.titulo = titulo;
                this.descripcion = descripcion || '';
                this.id_nodo_padre = id_nodo_padre;
                this.orden = orden || 0;
                this.hijos = [];
            }

            // A√±ade un hijo al nodo
            agregarHijo(nodo) {
                this.hijos.push(nodo);
            }

            // Verifica si tiene hijos
            tieneHijos() {
                return this.hijos.length > 0;
            }
        }

        class FAQSystem {
            constructor() {
                this.nodos = [];
                this.nextId = 1;
                this.loadFromStorage();
                this.searchTerm = '';
                this.pendingAction = null;
            }

            // Guarda en localStorage
            saveToStorage() {
                localStorage.setItem('faq_nodos', JSON.stringify(this.nodos));
                localStorage.setItem('faq_next_id', JSON.stringify(this.nextId));
            }

            // Carga desde localStorage
            loadFromStorage() {
                const savedNodos = localStorage.getItem('faq_nodos');
                const savedNextId = localStorage.getItem('faq_next_id');
                
                if (savedNodos) {
                    this.nodos = JSON.parse(savedNodos);
                } else {
                    this.initDefaultData();
                }
                
                if (savedNextId) {
                    this.nextId = parseInt(savedNextId);
                } else {
                    this.nextId = 1;
                    // Calcular el siguiente ID desde los nodos existentes
                    if (this.nodos.length > 0) {
                        const maxId = Math.max(...this.nodos.map(n => n.id_nodo));
                        this.nextId = maxId + 1;
                    }
                }
            }

            // Datos predeterminados
            initDefaultData() {
                const nodos = [
                    { id_nodo: 1, titulo: 'Becas', descripcion: 'Informaci√≥n general sobre becas disponibles', id_nodo_padre: null, orden: 0 },
                    { id_nodo: 2, titulo: 'Tipo de becas', descripcion: 'Tipos de becas seg√∫n perfil del estudiante', id_nodo_padre: 1, orden: 0 },
                    { id_nodo: 3, titulo: 'Gratuidad', descripcion: 'La gratuidad cubre el arancel de la carrera completa.', id_nodo_padre: 2, orden: 0 },
                    { id_nodo: 4, titulo: 'Postulaci√≥n', descripcion: 'Puedes postular a las becas a trav√©s del portal Mineduc.cl', id_nodo_padre: 1, orden: 1 },
                    { id_nodo: 5, titulo: 'C√≥mo pagar la mensualidad', descripcion: 'Puedes pagar en l√≠nea o en las cajas del campus.', id_nodo_padre: null, orden: 1 }
                ];
                this.nodos = nodos;
                this.nextId = 6;
                this.saveToStorage();
            }

            // Obtiene todos los nodos ra√≠z
            getRootNodes() {
                return this.nodos.filter(n => n.id_nodo_padre === null);
            }

            // Obtiene un nodo por ID
            getNodoById(id) {
                return this.nodos.find(n => n.id_nodo === id);
            }

            // Obtiene hijos de un nodo
            getHijos(id_padre) {
                return this.nodos.filter(n => n.id_nodo_padre === id_padre);
            }

            // Crea un nodo
            crearNodo(titulo, descripcion, id_nodo_padre) {
                // Validar que el t√≠tulo sea √∫nico en el mismo nivel
                if (this.tituloExisteEnNivel(titulo, id_nodo_padre)) {
                    return { success: false, error: 'Ya existe un nodo con este t√≠tulo en el mismo nivel' };
                }

                const nuevoNodo = {
                    id_nodo: this.nextId++,
                    titulo: titulo.trim(),
                    descripcion: descripcion.trim(),
                    id_nodo_padre: id_nodo_padre,
                    orden: 0
                };

                this.nodos.push(nuevoNodo);
                this.saveToStorage();
                return { success: true, nodo: nuevoNodo };
            }

            // Edita un nodo
            editarNodo(id, titulo, descripcion) {
                const nodo = this.getNodoById(id);
                if (!nodo) return { success: false, error: 'Nodo no encontrado' };

                // Validar que el t√≠tulo sea √∫nico en el mismo nivel (excepto el mismo nodo)
                if (this.tituloExisteEnNivel(titulo, nodo.id_nodo_padre, id)) {
                    return { success: false, error: 'Ya existe un nodo con este t√≠tulo en el mismo nivel' };
                }

                nodo.titulo = titulo.trim();
                nodo.descripcion = descripcion.trim();
                this.saveToStorage();
                return { success: true };
            }

            // Elimina un nodo
            eliminarNodo(id) {
                // Verificar si tiene hijos
                if (this.getHijos(id).length > 0) {
                    return { success: false, error: 'No se puede eliminar un nodo que tiene hijos' };
                }

                this.nodos = this.nodos.filter(n => n.id_nodo !== id);
                this.saveToStorage();
                return { success: true };
            }

            // Verifica si un t√≠tulo existe en el mismo nivel
            tituloExisteEnNivel(titulo, id_nodo_padre, excludeId = null) {
                return this.nodos.some(n => 
                    n.titulo.toLowerCase() === titulo.toLowerCase() && 
                    n.id_nodo_padre === id_nodo_padre &&
                    n.id_nodo !== excludeId
                );
            }

            // Construye el √°rbol jer√°rquico recursivamente
            construirArbol(nodos = null, padreId = null) {
                if (!nodos) nodos = this.nodos;
                if (padreId === undefined) padreId = null;

                const hijosDirectos = nodos.filter(n => n.id_nodo_padre === padreId)
                    .sort((a, b) => a.orden - b.orden);

                const arbol = hijosDirectos.map(nodo => {
                    const nodoConHijos = { ...nodo };
                    nodoConHijos.hijos = this.construirArbol(nodos, nodo.id_nodo);
                    return nodoConHijos;
                });

                return arbol;
            }

            // B√∫squeda por palabra clave
            buscar(keyword) {
                if (!keyword || keyword.trim() === '') return this.construirArbol();
                
                this.searchTerm = keyword.toLowerCase();
                const keywordLower = keyword.toLowerCase();
                
                const resultados = this.nodos.filter(n => 
                    n.titulo.toLowerCase().includes(keywordLower) ||
                    n.descripcion.toLowerCase().includes(keywordLower)
                );

                // Construir √°rbol parcial solo con resultados y sus ancestros
                const nodosIncluir = new Set();
                resultados.forEach(n => {
                    nodosIncluir.add(n.id_nodo);
                    // Incluir ancestros
                    let parentId = n.id_nodo_padre;
                    while (parentId !== null) {
                        nodosIncluir.add(parentId);
                        const parent = this.getNodoById(parentId);
                        parentId = parent ? parent.id_nodo_padre : null;
                    }
                });

                const nodosFiltrados = this.nodos.filter(n => nodosIncluir.has(n.id_nodo));
                return this.construirArbol(nodosFiltrados, null);
            }

            // Calcula estad√≠sticas
            getStats() {
                const total = this.nodos.length;
                const root = this.getRootNodes().length;
                
                // Calcular profundidad m√°xima
                const maxDepth = this.calcularProfundidadMaxima();

                return { total, root, maxDepth };
            }

            calcularProfundidadMaxima() {
                const profundidades = {};
                
                const calcularProfundidad = (id) => {
                    if (profundidades[id] !== undefined) {
                        return profundidades[id];
                    }

                    const nodo = this.getNodoById(id);
                    if (!nodo || nodo.id_nodo_padre === null) {
                        profundidades[id] = 0;
                        return 0;
                    }

                    profundidades[id] = calcularProfundidad(nodo.id_nodo_padre) + 1;
                    return profundidades[id];
                };

                this.nodos.forEach(n => {
                    calcularProfundidad(n.id_nodo);
                });

                return Math.max(...Object.values(profundidades), 0);
            }
        }

        // ============================================
        // INSTANCIA GLOBAL
        // ============================================

        const faqSystem = new FAQSystem();

        // ============================================
        // FUNCIONES DE UI
        // ============================================

        function renderTree() {
            const treeContainer = document.getElementById('treeContainer');
            let arbol;

            if (faqSystem.searchTerm && faqSystem.searchTerm.trim() !== '') {
                arbol = faqSystem.buscar(faqSystem.searchTerm);
            } else {
                arbol = faqSystem.construirArbol();
            }

            treeContainer.innerHTML = '';

            if (arbol.length === 0) {
                treeContainer.innerHTML = '<p class="text-slate-500 text-center py-8">No se encontraron nodos</p>';
                return;
            }

            arbol.forEach(nodo => {
                treeContainer.appendChild(renderNode(nodo, 0));
            });

            updateStats();
        }

        function renderNode(nodo, nivel) {
            const hasChildren = nodo.hijos && nodo.hijos.length > 0;
            const div = document.createElement('div');
            div.className = 'mb-2';
            
            const indent = nivel * 2;
            const isExpanded = localStorage.getItem(`faq_expanded_${nodo.id_nodo}`) !== 'false';

            div.innerHTML = `
                <div class="flex items-start gap-2 bg-slate-50 hover:bg-slate-100 p-3 rounded-lg transition">
                    <div style="margin-left: ${indent}rem;" class="flex items-start gap-2 flex-1">
                        ${hasChildren ? `
                            <button onclick="toggleNode(${nodo.id_nodo})" 
                                    class="collapse-arrow ${isExpanded ? 'open' : ''} mt-1 text-slate-400 hover:text-slate-600">
                                ‚ñ∂
                            </button>
                        ` : '<span class="w-4"></span>'}
                        
                        <div class="flex-1">
                            <div class="font-bold text-slate-900 mb-1" id="node-title-${nodo.id_nodo}">${highlightSearch(nodo.titulo)}</div>
                            ${nodo.descripcion ? `<div class="text-sm text-slate-600" id="node-desc-${nodo.id_nodo}">${highlightSearch(nodo.descripcion)}</div>` : ''}
                        </div>
                        
                        <div class="flex gap-1">
                            <button onclick="showEditModal(${nodo.id_nodo})" 
                                    class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 rounded">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="showDeleteConfirm(${nodo.id_nodo})" 
                                    class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 text-red-700 rounded">
                                üóëÔ∏è
                            </button>
                            <button onclick="showCreateChildModal(${nodo.id_nodo})" 
                                    class="px-2 py-1 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded">
                                ‚ûï
                            </button>
                        </div>
                    </div>
                </div>
                ${hasChildren ? `
                    <div id="children-${nodo.id_nodo}" class="node-children ${isExpanded ? '' : 'hidden'}">
                        ${nodo.hijos.map(hijo => renderNode(hijo, nivel + 1).outerHTML).join('')}
                    </div>
                ` : ''}
            `;

            return div;
        }

        function highlightSearch(text) {
            if (!faqSystem.searchTerm) return text;
            const regex = new RegExp(`(${faqSystem.searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function toggleNode(id) {
            const childrenDiv = document.getElementById(`children-${id}`);
            const button = document.querySelector(`button[onclick="toggleNode(${id})"]`);
            
            if (childrenDiv) {
                childrenDiv.classList.toggle('hidden');
                button.classList.toggle('open');
                localStorage.setItem(`faq_expanded_${id}`, !childrenDiv.classList.contains('hidden'));
            }
        }

        function collapseAll() {
            faqSystem.nodos.forEach(n => {
                localStorage.setItem(`faq_expanded_${n.id_nodo}`, 'false');
            });
            renderTree();
        }

        function updateStats() {
            const stats = faqSystem.getStats();
            document.getElementById('totalNodes').textContent = stats.total;
            document.getElementById('rootNodes').textContent = stats.root;
            document.getElementById('maxDepth').textContent = stats.maxDepth;
        }

        // ============================================
        // MODALES
        // ============================================

        let currentNodeId = null;
        let currentParentId = null;

        function showCreateModal() {
            currentNodeId = null;
            currentParentId = null;
            document.getElementById('modalTitle').textContent = 'Crear Nodo Ra√≠z';
            document.getElementById('nodeTitle').value = '';
            document.getElementById('nodeDesc').value = '';
            document.getElementById('nodeId').value = '';
            document.getElementById('parentId').value = '';
            document.getElementById('parentTitle').textContent = 'Ra√≠z';
            document.getElementById('titleError').classList.add('hidden');
            document.getElementById('nodeModal').classList.remove('hidden');
            document.getElementById('nodeModal').classList.add('flex');
            document.getElementById('nodeTitle').focus();
        }

        function showCreateChildModal(parentId) {
            currentNodeId = null;
            currentParentId = parentId;
            const parent = faqSystem.getNodoById(parentId);
            document.getElementById('modalTitle').textContent = 'Crear Nodo Hijo';
            document.getElementById('nodeTitle').value = '';
            document.getElementById('nodeDesc').value = '';
            document.getElementById('nodeId').value = '';
            document.getElementById('parentId').value = parentId;
            document.getElementById('parentTitle').textContent = parent.titulo;
            document.getElementById('titleError').classList.add('hidden');
            document.getElementById('nodeModal').classList.remove('hidden');
            document.getElementById('nodeModal').classList.add('flex');
            document.getElementById('nodeTitle').focus();
        }

        function showEditModal(id) {
            currentNodeId = id;
            const nodo = faqSystem.getNodoById(id);
            if (!nodo) return;
            
            currentParentId = nodo.id_nodo_padre;
            const parentTitle = nodo.id_nodo_padre ? 
                faqSystem.getNodoById(nodo.id_nodo_padre).titulo : 'Ra√≠z';

            document.getElementById('modalTitle').textContent = 'Editar Nodo';
            document.getElementById('nodeTitle').value = nodo.titulo;
            document.getElementById('nodeDesc').value = nodo.descripcion || '';
            document.getElementById('nodeId').value = id;
            document.getElementById('parentId').value = nodo.id_nodo_padre || '';
            document.getElementById('parentTitle').textContent = parentTitle;
            document.getElementById('titleError').classList.add('hidden');
            document.getElementById('nodeModal').classList.remove('hidden');
            document.getElementById('nodeModal').classList.add('flex');
            document.getElementById('nodeTitle').focus();
        }

        function closeModal() {
            document.getElementById('nodeModal').classList.add('hidden');
            document.getElementById('nodeModal').classList.remove('flex');
        }

        function saveNode() {
            const titulo = document.getElementById('nodeTitle').value.trim();
            const descripcion = document.getElementById('nodeDesc').value.trim();
            const id = parseInt(document.getElementById('nodeId').value);
            const parentId = currentParentId;

            if (!titulo) {
                document.getElementById('titleError').textContent = 'El t√≠tulo es obligatorio';
                document.getElementById('titleError').classList.remove('hidden');
                return;
            }

            let resultado;
            if (id) {
                // Editar
                resultado = faqSystem.editarNodo(id, titulo, descripcion);
            } else {
                // Crear
                resultado = faqSystem.crearNodo(titulo, descripcion, parentId);
            }

            if (!resultado.success) {
                document.getElementById('titleError').textContent = resultado.error;
                document.getElementById('titleError').classList.remove('hidden');
                return;
            }

            closeModal();
            renderTree();
        }

        function showDeleteConfirm(id) {
            const nodo = faqSystem.getNodoById(id);
            if (!nodo) return;

            currentNodeId = id;
            document.getElementById('confirmMessage').textContent = 
                `¬øEst√°s seguro de eliminar el nodo "${nodo.titulo}"?`;
            
            faqSystem.pendingAction = () => {
                const resultado = faqSystem.eliminarNodo(id);
                if (resultado.success) {
                    renderTree();
                } else {
                    alert(resultado.error);
                }
                cancelConfirm();
            };

            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
        }

        function confirmAction() {
            if (faqSystem.pendingAction) {
                faqSystem.pendingAction();
            }
        }

        function cancelConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
            faqSystem.pendingAction = null;
        }

        // ============================================
        // B√öSQUEDA
        // ============================================

        document.getElementById('searchInput').addEventListener('input', (e) => {
            faqSystem.searchTerm = e.target.value;
            renderTree();
        });

        // ============================================
        // EXPORT/IMPORT
        // ============================================

        function exportJSON() {
            // Exportar como array plano de nodos (no √°rbol anidado) para compatibilidad
            const json = JSON.stringify(faqSystem.nodos, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'faq-export.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importJSON() {
            document.getElementById('jsonFileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    let nodosImportados = [];
                    
                    // Manejar ambos formatos: array plano o √°rbol anidado
                    if (Array.isArray(json)) {
                        // Si es un array, verificar si son nodos planos o √°rbol anidado
                        if (json.length > 0 && json[0].hijos !== undefined) {
                            // Es un √°rbol anidado, convertir a array plano
                            nodosImportados = flattenTree(json);
                        } else {
                            // Es un array plano de nodos
                            nodosImportados = json;
                        }
                    } else {
                        throw new Error('El formato del JSON no es v√°lido');
                    }
                    
                    if (confirm('¬øImportar datos? Esto sobrescribir√° los datos actuales.')) {
                        faqSystem.nodos = nodosImportados;
                        faqSystem.nextId = 1;
                        if (faqSystem.nodos.length > 0) {
                            const maxId = Math.max(...faqSystem.nodos.map(n => n.id_nodo));
                            faqSystem.nextId = maxId + 1;
                        }
                        faqSystem.saveToStorage();
                        renderTree();
                    }
                } catch (error) {
                    alert('Error al importar JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // Funci√≥n auxiliar para convertir √°rbol anidado a array plano
        function flattenTree(arbol, result = []) {
            for (const nodo of arbol) {
                // Crear copia del nodo sin la propiedad hijos
                const { hijos, ...nodoPlano } = nodo;
                result.push(nodoPlano);
                
                // Si tiene hijos, procesarlos recursivamente
                if (hijos && hijos.length > 0) {
                    flattenTree(hijos, result);
                }
            }
            return result;
        }

        function resetToDefaults() {
            if (confirm('¬øRestablecer a los datos predeterminados? Esto eliminar√° todos los nodos actuales.')) {
                faqSystem.initDefaultData();
                renderTree();
            }
        }

        // ============================================
        // COMPARTIR / EMBED (URL PARAM)
        // ============================================
        // Nota: La funci√≥n encodeTreeForParam est√° definida arriba junto con generateShare()

        function generateShare() {
            // Usar array plano de nodos (no √°rbol anidado) para compatibilidad con app/faq.html
            const nodos = faqSystem.nodos;
            const encoded = encodeTreeForParam(nodos);
            if (!encoded) return;
            
            // Construir URL hacia app/faq.html desde la ubicaci√≥n actual
            const currentUrl = new URL(window.location.href);
            // Subir un nivel desde admin/ y entrar a app/
            const faqUrl = new URL('../app/faq.html', currentUrl);
            faqUrl.searchParams.set('faq', encoded);
            
            document.getElementById('shareOutput').value = faqUrl.toString();
        }
        
        // Renombrar funci√≥n para mayor claridad (aunque el nombre sigue siendo v√°lido)
        function encodeTreeForParam(data) {
            try {
                const json = JSON.stringify(data);
                // Base64 URL-safe
                const b64 = btoa(unescape(encodeURIComponent(json)))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
                return b64;
            } catch (e) {
                alert('Error al codificar: ' + e.message);
                return '';
            }
        }

        function copyEmbed() {
            let link = document.getElementById('shareOutput').value.trim();
            if (!link) {
                generateShare();
                link = document.getElementById('shareOutput').value.trim();
            }
            if (!link) return;
            const iframe = `<iframe src="${link}" width="100%" height="600" frameborder="0" loading="lazy"></iframe>`;
            document.getElementById('shareOutput').value = iframe;
            navigator.clipboard.writeText(iframe).then(() => {
                alert('Iframe copiado al portapapeles');
            }).catch(() => {});
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            renderTree();
        });
    </script>
</body>
</html>

